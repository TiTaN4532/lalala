{% extends "LaNetLaNetBundle::layout.html.twig" %}

{% block content %}
    
    <div style="padding-bottom:20px;" class="search-form">
        <form id="form_sub" action="">
            <div class="search-form-row">
                <input id="search-on-name" placeholder="Название" class="search-form-field" type="text" name="name" {% if app.request.query.get('name') %}value="{{ app.request.query.get('name') }}"{% endif %}>
                <img class="search-form-icon" src="{{ asset('images/search.png') }}" alt="search-icon">
            </div>
            <input class="search-form-btn" type="submit" value="Поиск">
        
            
            
  <div>
        <a href='#' style="padding-top:20px;" id='trigger'><h4>Расширеный поиск</h4></a>
        <div id='box' {% if not app.request.query.get('category') %} style='display: none;{% endif %} padding-bottom:20px;'><div style="margin:10px 0 ;">{{ "Поиск товара по категории:" | upper }}</div>

            <select name="category" class="half" id="category">
          <option value="0">Выберите категорию</option>
          {% for item in masterCategory %}
            <option value="{{ item.id }}" {% if app.request.query.get('category') == item.id  %} selected="selected"{% endif %}>{{ item.name }}</option>
          {% endfor %}
        </select>
                       
        {% if app.request.query.get('category') and brands is not empty  %}
        
        <select name="brand" class="half" id="brand-select">
               <option value="0">Выберите бренд</option>
          {% for brand in  brands %}
            <option value="{{ brand.id }}" {% if app.request.query.get('brand') == brand.id  %} selected="selected"{% endif %}>{{ brand.name }}</option>
          {% endfor %}
        </select>
        
        {% endif %}  
              
        {% if app.request.query.get('brand') and app.request.query.get('category') and product_cat is not empty %}
        
         <select name="product_cat" class="half" id="product_cat">
               <option value="0">Выберите категорию</option>
          {% for cat in  product_cat %}
            <option value="{{ cat.id }}" {%  if app.request.query.get('product_cat') == cat.id %} selected="selected"{% endif %}>{{ cat.name }}</option>
          {% endfor %}
        </select>
        
         {% endif %}  
        
         {% if app.request.query.get('brand') and app.request.query.get('category') %}
         
         {% for key_select, select in  selectedCategories %}
                                  
             <select name="{{key_select}}" class="half product_sub_cat">
               <option value="0">Выберите категорию</option>
             {% for key, val in  select %}
                  {% for category in  val %}
                   <option value="{{ category.id}}" {% if category.id == key_select %} selected="selected"{% endif %}>{{ category.name }}</option> 
         {% endfor %}
            {% endfor %}
            </select>
            
         {% endfor %}
         {% endif %} 
  </div> 

 </div>     
          
        </form>
    </div>
    
    
    
    
    
   
    {#<div style="margin:10px 0 ;">{{ "Выбор товара согласно вашим критериям:" | upper }}</div><form action="" id="form_sub" >
        <div><input id="search-on-name" placeholder="Поиск продукции по названию" style="margin-bottom:70;width:80%;" type="text" name="name" {% if app.request.query.get('name') %}value="{{ app.request.query.get('name') }}"{% endif %}></div>   
      
        <select name="category" class="half" id="category">
          <option value="0">Выберите специальность</option>
          {% for item in masterCategory %}
            <option value="{{ item.id }}" {% if app.request.query.get('category') == item.id  %} selected="selected"{% endif %}>{{ item.name }}</option>
          {% endfor %}
        </select>
                       
        {% if app.request.query.get('category') and brands is not empty  %}
        
        <select name="brand" class="half" id="brand-select">
               <option value="0">Выберите бренд</option>
          {% for brand in  brands %}
            <option value="{{ brand.id }}" {% if app.request.query.get('brand') == brand.id  %} selected="selected"{% endif %}>{{ brand.name }}</option>
          {% endfor %}
        </select>
        
        {% endif %}  
              
        {% if app.request.query.get('brand') and app.request.query.get('category') and product_cat is not empty %}
        
         <select name="product_cat" class="half" id="product_cat">
               <option value="0">Выберите категорию</option>
          {% for cat in  product_cat %}
            <option value="{{ cat.id }}" {%  if app.request.query.get('product_cat') == cat.id %} selected="selected"{% endif %}>{{ cat.name }}</option>
          {% endfor %}
        </select>
        
         {% endif %}  
        
         {% if app.request.query.get('brand') and app.request.query.get('category') %}
         
         {% for key_select, select in  selectedCategories %}
                                  
             <select name="{{key_select}}" class="half product_sub_cat">
               <option value="0">Выберите категорию</option>
             {% for key, val in  select %}
                  {% for category in  val %}
                   <option value="{{ category.id}}" {% if category.id == key_select %} selected="selected"{% endif %}>{{ category.name }}</option> 
         {% endfor %}
            {% endfor %}
            </select>
            
         {% endfor %}
         {% endif %}  
               
         {#% if app.request.query.get('product_cat') %}
         
         <select name="product_sub_cat" class="half" id="product_sub_cat">
               <option value="0">Выберите подкатегорию</option>
                   {% for sub_cat in  product_sub_cat %}
            <option value="{{ sub_cat.id }}" {% if selectedCategories is defined  %} selected="selected"{% endif %}>{{ sub_cat.name }}</option>
          {% endfor %}
        </select>       
        
         {% endif % 
        
        
     <div id="submit_button"><input type="submit" value="Фильтровать"></div>
      </form>#}
    
              
        
     <h2>Товары:</h2>
              {% for product in products %}
              <div class="row">
          <div class="col col_1_of_3"><img src="{{ asset(product.getWebPath)}}" style="width:100%;" /></div>
          <div class="col col_2_of_3" style="font-weight: 900">
               {{ product.name }}
          </div>
                <div class="col col_2_of_3">
    {% if product.description|length < 250 %}
        {{ product.description}}
     {% else%}
         <div class="product-description-wrapper">
         <div class="desc">{{ product.description|striptags|slice(0, 250) }}...<div class="button_desc"><a class="blue-link" style="cursor:pointer;">Читать далее</a></div></div>
         <div class="trimed-desc" style="display: none;">{{ product.description}}<div class="button_trimed-desc"><a class="blue-link" style="cursor:pointer;">Свернуть</a></div></div>
         </div>
         {% endif%}
     
        </div>
        </div>
              <hr/>
              {% else %}
                Пока нет товаров
              {% endfor %}
                   
         <script type="text/javascript">
          $("A#trigger").click(function(event){
               event.preventDefault();
        $("DIV#box").toggle();
    });
   
        
        
        $(".button_desc").click(function(){
        $(this).parents(".product-description-wrapper").find(".desc").hide();
        $(this).parents(".product-description-wrapper").find(".trimed-desc").show();
                
      });
   
        $(".button_trimed-desc").click(function(){
        $(this).parents('.product-description-wrapper').find(".trimed-desc").hide();
        $(this).parents('.product-description-wrapper').find(".desc").show();
        
      });

        </script>    
        
        
        <script>
  
    //Подгружаем список брендов по выбору специализации  
    
  $("#category").change(function(){
       
        $(this).nextAll().not($("#submit_button")).remove(); 
        
        var cat = $("#category option:selected").val();
     
     if (cat != '0') { 
          
       $.ajax({
            url: Routing.generate('la_net_la_net_ajax_menu_getBrand'),
            data: {id: cat},
            success: function (response) {
                if (response.length != 0) {
                var data = (response);
              
                var new_options =  '<div><select name="brand" class="half" id="brand-select"><option value="0">Выберите бренд</option>';
                $.each(data, function (index, value) {
                    new_options += '<option value="'+ value.id +'">'+ value.name +'</option>';
                  

                });
                
                  new_options += '</select></div>';
              $("#category").after(new_options);
       
       
    }  }});  }
      
   });   
     
     
      
  </script>    
  
   <script>
    
    
    //Подгружаем список категорий по выбору бренда и специализации
        
    $(document).on('change', '#brand-select', function ()  { 
    
    $(this).nextAll().not($("#submit_button")).remove();       
     
        var brand = $("#brand-select option:selected").val();
        var cat2 = $("#category option:selected").val();
       
       if (brand != '0') {
       
       $.ajax({
            url: Routing.generate('la_net_la_net_ajax_menu_getProductCategory'),
            data: {id_cat: cat2, id_brand: brand},
            success: function (response) {
                
                if (response.length != 0) {
                var data = (response);
                
                var new_options = '<div><select name="product_cat" class="half" id="product_cat"><option value="0">Выберите категорию</option>';
                $.each(data, function (index, value) {
                    new_options += '<option value="'+ value.id +'">'+ value.name +'</option>';
                  
                });
              new_options += '</select></div>';
              $('#brand-select').after(new_options);
       
    }}
    }); } 
      
    });   
          
  </script>    
  
  
  
  <script>
    
    //Подгружаем подкатегории в зависимости от категории
   
    $(document).on('change', '#product_cat', function ()  { 
   
     
         $(this).nextAll().not($("#submit_button")).remove();       
         var catParent = $("#product_cat option:selected").val();
          
         if (catParent != '0') {
        
       $.ajax({
            url: Routing.generate('la_net_la_net_ajax_menu_getProductSubCategory'),
            data: {id_parent: catParent},
            success: function (response) {
                
                if (response.length != 0) {
                var data = (response);
                                
                var new_options = '<div><select name="product_sub_cat" class="half product_sub_cat"><option value="0">Выберите подкатегорию</option>';
                $.each(data, function (index, value) {
                    new_options += '<option value="'+ value.id +'">'+ value.name +'</option>';
                  
                });
              new_options += '</select></div>';  
              $('#product_cat').after(new_options);
       
    }}
    })};  
      
    });   
      
  </script> 
  
  <script>
    
    //Подгружаем подкатегории бесконечной вложенности
   
    $(document).on('change', '.product_sub_cat', function ()  { 
   
   
   
         $(this).nextAll().not($("#submit_button")).remove(); 
         
         var catParent = $(".product_sub_cat option:selected").last().val();
          
         if (catParent != '0') {
        
       $.ajax({
            url: Routing.generate('la_net_la_net_ajax_menu_getProductSubCategory'),
            data: {id_parent: catParent},
            success: function (response) {
                
                if (response.length != 0) {
                var data = (response);
                                
                var new_options = '<div><select name="product_sub_cat" class="half product_sub_cat"><option value="0">Выберите подкатегорию</option>';
                $.each(data, function (index, value) {
                    new_options += '<option value="'+ value.id +'">'+ value.name +'</option>';
                  
                });
              new_options += '</select></div>';  
              $('.product_sub_cat').last().after(new_options);
       
    }}
    })};  
      
    });   
      
  </script>  
  
    <script> 
   $( document ).ready(function() {
     var lastSelectedSubCat = $(".product_sub_cat option:selected").last().val();
     
     if (typeof lastSelectedSubCat != "undefined" && lastSelectedSubCat !='0'){ 
        $.ajax({
            url: Routing.generate('la_net_la_net_ajax_menu_getProductSubCategory'),
            data: {id_parent: lastSelectedSubCat},
            success: function (response) {
                
                if (response.length != 0) {
                var data = (response);
                                
                var new_options = '<div><select name="product_sub_cat" class="half product_sub_cat"><option value="0">Выберите подкатегорию</option>';
                $.each(data, function (index, value) {
                    new_options += '<option value="'+ value.id +'">'+ value.name +'</option>';
                  
                });
              new_options += '</select></div>';  
              $('.product_sub_cat').last().after(new_options);
       
              }}
         }) 
     }
     else 
    {
       var lastSelectedCat = $("#product_cat option:selected").val();
       if (typeof lastSelectedCat != "undefined" && lastSelectedCat !='0')
        $.ajax({
            url: Routing.generate('la_net_la_net_ajax_menu_getProductSubCategory'),
            data: {id_parent: lastSelectedCat},
            success: function (response) {
                
                if (response.length != 0) {
                var data = (response);
                                
                var new_options = '<div><select name="product_sub_cat" class="half product_sub_cat"><option value="0">Выберите подкатегорию</option>';
                $.each(data, function (index, value) {
                    new_options += '<option value="'+ value.id +'">'+ value.name +'</option>';
                  
                });
              new_options += '</select></div>';  
              $('#product_cat').after(new_options);
       
              }}
         }) 
    }
        
        
});
   
    </script>  

  
  <script>  
    //Формируем данные перед отправкой в форме
    $("#form_sub").on('submit', function (event) {
  
    event.preventDefault()
    
    
    var categorySelected = $("#category").val();
    var brandSelected = $("#brand-select").val();
    var productCategorySelected = $("#product_cat").val();
    var productName = $("#search-on-name").val();
    
    var URL = "{{ url('la_net_la_net_product_list') }}";
        
    if (typeof categorySelected != "undefined" && categorySelected !='0')
    {
        URL += '?category=' +categorySelected;
    }
    
    if (typeof brandSelected != "undefined" && brandSelected !='0')
    {
        URL += '&brand=' +brandSelected;
    }
    
    
   if (typeof categorySelected != "undefined" && categorySelected !='0') {
    
    if (productName.length != 0)  
    {
        URL += '&name=' +productName;
    }
    
    }
    
    else {
        if (productName.length != 0)  
    {
        URL += '?name=' +productName;
    } 
        
    }
        
    if (typeof productCategorySelected != "undefined" && productCategorySelected !='0')
    {
        URL += '&product_cat=' +productCategorySelected;
    }
        
    var productSubCatSelected = $(".product_sub_cat option:selected").last().val();
   
    if (typeof productSubCatSelected != "undefined" && productSubCatSelected !='0') 
        {
           URL += '&product_sub_cat=' +productSubCatSelected;
        }
    
    else 
    {
    
    var productSubCatPrevSelected = $(".product_sub_cat option:selected").eq(-2).val();
     
     if (typeof productSubCatPrevSelected != "undefined" && productSubCatPrevSelected !='0')
       {
           URL += '&product_sub_cat=' +productSubCatPrevSelected;
       }
    }
 
      window.location.replace(URL);
        
    } );
  
   </script>  
  
  
  
        
{% endblock %}

